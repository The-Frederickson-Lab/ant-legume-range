---
title: "Mutualism promotes range expansion in both ant and plant partners"
author: "Pooja Nathan and Megan Frederickson"
date: "29/11/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# How does mutualism affect ant and plant range sizes? 
This R Markdown document describes the dataset and code for:

Nathan P, Frederickson ME. In prep. Mutualism promotes range expansion in both ant and plant partners. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The first step is to load packages

```{r packages, warning=FALSE, message=FALSE}
library(olsrr)
library(ape)
library(geiger)
library(nlme)
library(phytools)
#library(plotrix)
library(caper)
library(tidyverse)
library(cowplot)
#library(devtools)
```

## Analysis for effect of EFNs on legume range size

```{r merge EFN and legume datasets, warning=FALSE, message=FALSE}
range <- read.csv("legume_invasion_data.csv") #Read in legume range data
EFN <- read.csv("EFN_fromwhole.csv") #Read in EFN data
domatia <- read.csv("domatia_fromwhole.csv")  #Read in Domatia data
colnames(EFN) <- c("Species", "EFN") #Fix column names
colnames(domatia) <- c("Species", "Domatia")
range <- merge(EFN, range, by='Species', all.x=FALSE, all.y=TRUE) #Merge legume range and EFN data
range <- merge(domatia, range, by='Species', all.x=FALSE, all.y=TRUE) #Merge legume range and domatia data
range$EFN <- ifelse(is.na(range$EFN), 0, range$EFN) #Make NAs zeros for EFNs
range$Domatia <- ifelse(is.na(range$Domatia), 0, range$Domatia) #Make NAs zeros for domatia
```

## Make figures

## Number of introduced ranges

```{r number introduced ranges, warning=FALSE, message=FALSE}
range$fixer <- as.factor(range$fixer) #Make factor
range$EFN <- as.factor(range$EFN)
range$Domatia <- as.factor(range$Domatia)
hues <- c("#af8dc3", "#7fbf7b")

#EFNs
fig1a <- ggplot(data=range)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=EFN, fill=EFN, x=EFN, y=(num_introduced+1)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Extrafloral nectaries") + 
  ylab("Introduced ranges (no. + 1)")+
  stat_summary(aes(x=EFN, y=(num_introduced+1)), fun="mean", geom="crossbar", width=0.25)+
  theme_cowplot() +
  theme(legend.position = "none")+
  scale_y_log10()

fig1a
#Domatia
fig1b <- ggplot(data=range)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=Domatia, fill=Domatia, x=Domatia, y=(num_introduced+1)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Domatia") + 
  ylab("Introduced ranges (no. + 1)")+
  stat_summary(aes(x=Domatia, y=(num_introduced+1)), fun="mean", geom="crossbar", width=0.25)+
  theme_cowplot() +
  theme(legend.position = "none")+
  scale_y_log10()


#Nodules
fig1c <- ggplot(data=range)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=fixer, fill=fixer, x=fixer, y=(num_introduced+1)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Nodules") + 
  ylab("Introduced ranges (no. + 1)")+
  stat_summary(aes(x=fixer, y=(num_introduced+1)), fun="mean", geom="crossbar", width=0.25)+
  theme_cowplot() +
  theme(legend.position = "none")+
  scale_y_log10()

fig1 <- plot_grid(fig1a, fig1b, fig1c, labels="AUTO",  ncol = 3, nrow = 1)
fig1
ggsave(fig1, device = "jpeg", filename = "Fig1.jpg")
```

## Native range area

```{r native range area, message=FALSE, warning=FALSE}
#EFNs
fig2a <- ggplot(data=range)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=EFN, fill=EFN, x=EFN, y=(total_area_native/1e+6)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Extrafloral nectaries") + 
  ylab("Native range area (sq. km)")+
  theme_cowplot() +
  theme(legend.position = "none")+
  stat_summary(aes(x=EFN, y=(total_area_native/1e+6)), fun="mean", geom="crossbar", width=0.25)+
  scale_y_log10()

#Domatia
fig2b <- ggplot(data=range)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=Domatia, fill=Domatia, x=Domatia, y=(total_area_native/1e+6)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Domatia") + 
  ylab("Native range area (sq. km)")+
  theme_cowplot() +
  theme(legend.position = "none")+
  stat_summary(aes(x=Domatia, y=(total_area_native/1e+6)), fun="mean", geom="crossbar", width=0.25)+
  scale_y_log10()

#Nodules
fig2c <- ggplot(data=range)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=fixer, fill=fixer, x=fixer, y=(total_area_native/1e+6)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Nodules") + 
  ylab("Native range area (sq. km)")+
  stat_summary(aes(x=fixer, y=(total_area_native/1e+6)), fun="mean", geom="crossbar", width=0.25)+
  theme_cowplot() +
  theme(legend.position = "none")+
  scale_y_log10()

fig2 <- plot_grid(fig2a, fig2b, fig2c, labels="AUTO", ncol = 3, nrow = 1)
fig2
ggsave(fig2, device = "jpeg", filename = "Fig2.jpg")

```

## Preparing dataset for pgls analysis

```{r PGLS, warning=FALSE, message=FALSE}
zanne <- read.tree("Vascular_Plants_rooted.dated.tre") #reading in Zanne et al. 2014 plant phylogeny
phyint <- intersect(zanne$tip.label, range$Species)  
phydiff <- setdiff(zanne$tip.label, range$Species)
pruned.tree.pgls <- drop.tip(zanne, phydiff) #dropping tips not in the dataset

range_efn_pgls <- range[range$Species %in% phyint, ]
range_efn_pgls <- range_efn_pgls[complete.cases(range_efn_pgls), ] #removing NA elements
```

## Statistical models for EFN

```{r models1, warning=FALSE, message=FALSE}
#PGLS of number of introduced ranges as response variable with EFNs and rhizobial symbiosis, 
#interaction and other covariates
#p1 <- gls(log(num_introduced + 1) ~ EFN + fixer + EFN*fixer + total_area_native + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls) 
#summary(p1)

#EFN significant positive, fixer and interaction not significant

#PGLS with both, covariates and no interaction (dropping interaction because it was non-signif.)

p2 <- gls(log(num_introduced + 1) ~ EFN+fixer +
            total_area_native + abs_lat_native + annual + uses_num_uses, 
            correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), 
            method = "ML", data = range_efn_pgls) 
summary(p2)
#EFN significant positive, fixer not significant, slightly lower AIC 

#Diagnostic plots
plot(p2$residuals, p2$fitted)
qqnorm(p2$residuals)
qqline(p2$residuals)

#Running a linear model with a quasipoisson distribution on number of intriduced ranges

p3 <- glm(num_introduced ~ EFN + fixer + total_area_native + abs_lat_native + annual + uses_num_uses, family="quasipoisson", data=range_efn_pgls)
summary(p3)

#Analysis for area introduced
#PGLS with both EFN presence and fixer, interaction and covariates
#p4 <- gls(log((total_area_introduced/1e+6)+1) ~ EFN + fixer = EFN*fixer + total_area_native + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls) 

#summary(p4)
#EFN significant positive, fixer and interaction not significant

#PGLS with both, covariates and no interaction
p5 <- gls(log((total_area_introduced/1e+6)+1) ~ EFN + fixer + total_area_native + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls) 
summary(p5)

#EFN significant positive, fixer not significant, slightly lower AIC 

plot(p5$residuals, p5$fitted)
qqnorm(p5$residuals)
qqline(p5$residuals)


#Repeating for native area
#PGLS with both EFN presence and fixer, interaction and covariates
#p6 <- gls(log((total_area_native/1e+6) + 1) ~ EFN + fixer + EFN*fixer + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls)
#summary(p6)
#all effects non-significant

#PGLS with both EFN presence and fixer, covariates and no interaction
p7 <- gls(log((total_area_native/1e+6) + 1)~ EFN+fixer +abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species),  method = "ML", data = range_efn_pgls) 
summary(p7)
#all mututalism effects non-significant

#Diagnostic plots

plot(p7$residuals, p7$fitted)
qqnorm(p7$residuals)
qqline(p7$residuals)

```

## Statistical models for Domatia

```{r models2, warning=FALSE, message=FALSE}

#PGLS of number of introduced ranges as response variable with domatia and rhizobial symbiosis, 
#interaction and other covariates
p8 <- gls(log(num_introduced + 1) ~ Domatia + fixer + Domatia*fixer + total_area_native + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls) 
summary(p8)

#Neither mutualism nor interaction significant

#Diagnostic plots
plot(p8$residuals, p8$fitted)
qqnorm(p8$residuals)
qqline(p8$residuals)

#Running a linear model with a quasipoisson distribution on number of introduced ranges

p9 <- glm(num_introduced ~ Domatia + fixer + total_area_native + abs_lat_native + annual + uses_num_uses, family="quasipoisson", data=range_efn_pgls)
summary(p9)

#Results qualitatively similar

#Analysis for area introduced
#PGLS with both domatia presence and fixer, interaction and covariates
p10 <- gls(log((total_area_introduced/1e+6)+1) ~ Domatia + fixer + Domatia*fixer + total_area_native + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls) 

summary(p10)
#EFN significant positive, fixer and interaction not significant

plot(p10$residuals, p10$fitted)
qqnorm(p10$residuals)
qqline(p10$residuals)


#Repeating for native area
#PGLS with both Domatia presence and fixer, interaction and covariates
p11 <- gls(log((total_area_native/1e+6) + 1) ~ Domatia + fixer + Domatia*fixer + abs_lat_native + annual + uses_num_uses, correlation = corPagel(1, phy = pruned.tree.pgls, form = ~ Species), method = "ML", data = range_efn_pgls)
summary(p11)
#all mutualism effects non-significant


plot(p11$residuals, p11$fitted)
qqnorm(p11$residuals)
qqline(p11$residuals)

```

# Do EFN-visiting ants have higher range size?

```{r efns and ants, warning=FALSE, message=FALSE}
###Native range size
antarea <- read.csv("Ant_species_native range.csv")
antefn <- read.csv("Species_EFN_Data.csv")
antdom <- read.csv("Species_Domatia_Data_Phy.csv")

efn_area <- merge(antarea, antefn, by.y = "Phy", all = FALSE)
dom_area <- merge(antarea, antdom, by.y = "Phy", all = FALSE)
efn_area$EFN <- as.factor(efn_area$EFN)
dom_area$Domatia <- as.factor(dom_area$Domatia)

fig3a <- ggplot(data=efn_area)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=EFN, fill=EFN, x=EFN, y=total.area), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Visits extrafloral nectaries") + 
  ylab("Native range area (sq. km)")+
  theme_cowplot() +
  theme(legend.position = "none")+
  stat_summary(aes(x=EFN, y=total.area), fun="mean", geom="crossbar", width=0.25)+
  scale_y_log10()

fig3b <- ggplot(data=dom_area)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=Domatia, fill=Domatia, x=Domatia, y=total.area), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Resides in domatias") + 
  ylab("Native range area (sq. km)")+
  theme_cowplot() +
  theme(legend.position = "none")+
  stat_summary(aes(x=Domatia, y=total.area), fun="mean", geom="crossbar", width=0.25)+
  scale_y_log10()

fig3 <- plot_grid(fig3a, fig3b,labels="AUTO", ncol = 2, nrow = 1)
fig3
ggsave(fig3, device = "jpeg", filename = "Fig3.jpg")

### Invaded range size
efn_inv <- read.csv("invaded_area_ant_species.csv")
antefn <- read.csv("Species_EFN_Data.csv")
colnames(efn_inv) <- c("Phy", "SD", "LogArea")
efn_area_inv <- merge(efn_inv, antefn, by = "Phy", all = FALSE)
efn_area_inv$EFN <- as.factor(efn_area_inv$EFN)

fig4 <- ggplot(data=efn_area_inv)+
  scale_fill_manual(values=hues) +
  scale_colour_manual(values=hues) +
  geom_violin(aes(color=EFN, fill=EFN, x=EFN, y=(10^LogArea+1)), alpha=0.7)+
  scale_x_discrete(breaks=c("0","1"),
                   labels=c("No", "Yes")) + 
  xlab("Visits extrafloral nectaries") + 
  ylab("Introduced range area (sq. km + 1)")+
  theme_cowplot() +
  theme(legend.position = "none")+
  stat_summary(aes(x=EFN, y=(10^LogArea+1)), fun="mean", geom="crossbar", width=0.25)+
  scale_y_log10()

ggsave(fig4, device = "jpeg", filename = "Fig3.jpg")

```

```{r efns/domatia and ants models, warning=FALSE, message=FALSE}
#EFNs
#Native range size
ant_tree <- read.tree("Ant_tree.tre") #Reading in ant phylogeny
phy_int <- intersect(ant_tree$tip.label, efn_area$Phy)
phy_diff <- setdiff(ant_tree$tip.label, efn_area$Phy)
pruned_ant_tree <- drop.tip(ant_tree, as.character(phy_diff)) #pruning tree to contain only tips in the dataset

efn_area_phy <- efn_area[efn_area$Phy %in% phy_int, ] #dataset for pgls
#write.csv(efn_area_phy, "Ant_list_EFN.csv")
efn_area_phy <- efn_area_phy[match(pruned_ant_tree$tip.label, efn_area_phy$Phy),]

#PGLS model
a1 <- gls(LogArea ~ EFN, 
                correlation = corPagel(1, phy = pruned_ant_tree, form = ~ Phy), 
                method = "ML", data = efn_area_phy) 
summary(a1) #Significant positive effect of EFNs

#Diagnostic plots
plot(a1$residuals, a1$fitted)
qqnorm(a1$residuals)
qqline(a1$residuals)

### Invaded range size
phy_int <- intersect(ant_tree$tip.label, efn_area_inv$Phy)
phy_diff <- setdiff(ant_tree$tip.label, efn_area_inv$Phy)
pruned_ant_tree <- drop.tip(ant_tree, as.character(phy_diff))

efn_area_inv_phy <- efn_area_inv[efn_area_inv$Phy %in% phy_int, ] #dataset for pgls
efn_area_inv_phy <- efn_area_inv_phy[match(pruned_ant_tree$tip.label, efn_area_inv_phy$Phy),]

#PGLS model
a2 <- gls(LogArea ~ EFN, 
          correlation = corPagel(1, phy = pruned_ant_tree, form = ~ Phy), 
          method = "ML", data = efn_area_inv_phy) 
summary(a2)

## Diagnostic plots
plot(a2$residuals, a2$fitted)
qqnorm(a2$residuals)
qqline(a2$residuals)

##Domatia
#Native range size
phy_int <- intersect(ant_tree$tip.label, dom_area$Phy)
phy_diff <- setdiff(ant_tree$tip.label, dom_area$Phy)
pruned_ant_tree_dom <- drop.tip(ant_tree, as.character(phy_diff)) #pruning tree to contain only tips in the dataset

dom_area_phy <- dom_area[dom_area$Phy %in% phy_int, ] #dataset for pgls
dom_area_phy <- dom_area_phy[match(pruned_ant_tree_dom$tip.label, dom_area_phy$Phy),]

a3 <- gls(LogArea ~ Domatia, 
                correlation = corPagel(1, phy = pruned_ant_tree_dom, form = ~ Phy), 
                method = "ML", data = dom_area_phy) 
summary(a3)
```





